# Integration Tests

This directory contains comprehensive integration tests for the Computor platform, focusing on permission testing across different user roles (students, tutors, lecturers).

## Directory Structure

```
tests/integration/
├── README.md                           # This file
├── config/                             # Configuration files
│   ├── .env.template                   # Environment template (copy to .env)
│   ├── .env                           # Your configuration (git-ignored)
│   ├── deployment.yaml                # Test hierarchy definition
│   └── .gitignore
├── scripts/                           # Test scripts
│   ├── setup_test_environment.sh      # Environment setup script
│   ├── run_all_tests.py              # Main test runner
│   ├── test_helpers.py               # Shared utilities
│   ├── test_student_permissions.py   # Student role tests
│   ├── test_tutor_permissions.py     # Tutor role tests
│   └── test_lecturer_permissions.py  # Lecturer role tests
└── data/                             # Test results (git-ignored)
    ├── .gitkeep
    ├── student_test_results.json     # Generated by tests
    ├── tutor_test_results.json       # Generated by tests
    ├── lecturer_test_results.json    # Generated by tests
    └── test_summary.json             # Overall summary
```

## Prerequisites

### 1. Running Services

Ensure the following services are running:

- **PostgreSQL Database** (port 5432)
- **Redis** (port 6379)
- **Temporal Server** (port 7233)
- **MinIO** (port 9000)
- **GitLab** (local instance - provide URL in .env)
- **Computor API** (port 8000)

To start all services except GitLab:

```bash
cd /home/theta/computor/computor-fullstack
bash startup.sh
bash api.sh
```

### 2. Python Dependencies

Install required Python packages:

```bash
# From the project root
pip install -e computor-types/
pip install -e computor-client/
pip install -e computor-cli/
pip install -e computor-backend/

# Additional test dependencies
pip install httpx python-dotenv
```

### 3. GitLab Server Setup

You need a local GitLab instance running. This can be:

- GitLab in Docker
- GitLab installed locally
- A remote GitLab instance you have admin access to

**Important Setup Requirements:**

1. **Root Credentials:** You need the GitLab root username and password

2. **Parent Group:** Create a parent GitLab group where test organizations will live:
   - Log into GitLab as root
   - Create a new group (e.g., "computor-tests")
   - Note the group ID (found in the group settings)

3. **Group Owner Token:** Create an owner token for the parent group:
   - Go to the parent group settings
   - Create a new group access token with **Owner** role
   - Required scopes: `api`, `read_repository`, `write_repository`
   - Save this token - you'll need it in the `.env` file

This setup allows Computor to manage organizations (as GitLab subgroups) within the parent group.

## Setup Instructions

### Step 1: Configure Environment

1. Copy the environment template:

```bash
cd tests/integration/config
cp .env.template .env
```

2. Edit `.env` and fill in your GitLab details:

```bash
# Example configuration
GITLAB_URL=http://localhost:8929              # Your GitLab URL
GITLAB_ROOT_USERNAME=root
GITLAB_ROOT_PASSWORD=your_password_here

# Parent group where organizations will be created (see GitLab setup above)
GITLAB_PARENT_GROUP_ID=123                    # The parent group ID

# Owner token for the parent group (with api, read/write repo scopes)
GITLAB_TOKEN=glpat-xxxxxxxxxxxxxxxxxxxx

# The rest can usually stay as defaults
API_BASE_URL=http://localhost:8000
DB_HOST=localhost
DB_PORT=5432
# ... etc
```

**Note about GitLab URL:**
- If your GitLab includes a port: `http://localhost:8929`
- If it's a domain without port: `https://gitlab.example.com`
- Both formats are supported

**Finding the GitLab Parent Group ID:**
- Go to your parent group in GitLab
- Settings → General
- The group ID is shown at the top of the page

### Step 2: Run Setup Script

The setup script will:
- Verify all services are running
- Deploy the test organization/course hierarchy
- Create test users with appropriate roles
- Verify everything is ready

```bash
cd tests/integration/scripts
./setup_test_environment.sh
```

If successful, you should see:

```
✓ Configuration loaded from .env
✓ API is running at http://localhost:8000
✓ GitLab is accessible at http://localhost:8929
✓ Database is running
✓ Deployment successful
✓ Organization 'test-university' exists
✓ Course 'programming-101' exists
...
Setup Complete!
```

### Step 3: Run Tests

#### Run All Tests

```bash
cd tests/integration/scripts
python3 run_all_tests.py
```

This will run all permission tests sequentially and generate a comprehensive report.

#### Run Individual Test Suites

```bash
# Test student permissions
python3 test_student_permissions.py

# Test tutor permissions
python3 test_tutor_permissions.py

# Test lecturer permissions
python3 test_lecturer_permissions.py
```

## Test Coverage

### Student Permission Tests

Tests verify that students can:
- ✅ View their own profile
- ✅ List organizations and courses
- ✅ View course content
- ✅ Submit assignments
- ✅ View their own submissions

And **cannot**:
- ❌ Create/modify organizations or courses
- ❌ View other students' submissions
- ❌ Grade submissions
- ❌ Manage course members
- ❌ Access admin endpoints

### Tutor Permission Tests

Tests verify that tutors can:
- ✅ View their own profile
- ✅ List organizations and courses
- ✅ View all course content
- ✅ View all submissions for their courses
- ✅ Grade submissions
- ✅ View student lists

And **cannot**:
- ❌ Create/modify course structure
- ❌ Create/modify course content
- ❌ Manage course members (add/remove students)
- ❌ Create organizations
- ❌ Access admin endpoints

### Lecturer Permission Tests

Tests verify that lecturers can:
- ✅ View and update their courses
- ✅ Create/modify course content
- ✅ View all submissions
- ✅ Grade submissions
- ✅ Manage course members (add/remove students and tutors)
- ✅ Configure course settings

And **cannot**:
- ❌ Create/delete organizations
- ❌ Manage users outside their courses
- ❌ Access system-wide admin endpoints
- ❌ Create execution backends

## Understanding Results

### Console Output

Each test shows:
- ✓ Passed tests (green)
- ✗ Failed tests (red)
- Expected vs actual HTTP status codes

Example:
```
✓ View own user profile
  GET /user
  Expected: 200, Got: 200

✗ Create organization (should fail)
  POST /organizations
  Expected: 403, Got: 403
```

### JSON Results

Results are saved in `tests/integration/data/`:

- `student_test_results.json` - Student permission test results
- `tutor_test_results.json` - Tutor permission test results
- `lecturer_test_results.json` - Lecturer permission test results
- `test_summary.json` - Overall summary

Example JSON structure:
```json
{
  "total": 25,
  "passed": 23,
  "failed": 2,
  "results": [
    {
      "endpoint": "/user",
      "method": "GET",
      "user_role": "student",
      "expected_status": 200,
      "actual_status": 200,
      "passed": true
    }
  ]
}
```

## Test Deployment Hierarchy

The `config/deployment.yaml` creates:

**Organization:** Test University
- **Course Family:** Computer Science
  - **Course:** Programming 101
    - Content Types: Lecture, Homework, Project
    - Execution Backend: Python (Temporal)

**Users Created:**
- `admin` - System administrator
- `lecturer1` - Course lecturer
- `tutor1`, `tutor2` - Teaching assistants
- `student1`, `student2`, `student3` - Students

**Course Memberships:**
- Lecturer: `lecturer1` as `_lecturer`
- Tutors: `tutor1`, `tutor2` as `_tutor`
- Students: `student1`, `student2`, `student3` as `_student`

## Troubleshooting

### API Not Responding

```
✗ API is not responding at http://localhost:8000
```

**Solution:** Start the API server:
```bash
cd /home/theta/computor/computor-fullstack
bash api.sh
```

### GitLab Not Accessible

```
⚠ GitLab may not be accessible at http://localhost:8929
```

**Solution:**
1. Check your GitLab URL in `.env`
2. Verify GitLab is running
3. For domain names without ports, use `https://` instead of `http://`

### Authentication Failed

```
❌ Authentication failed for student1
```

**Solution:**
1. Check user passwords in `.env` match `deployment.yaml`
2. Verify deployment was successful
3. Check that users were created in the database

### Deployment Failed

```
✗ Deployment failed
```

**Solution:**
1. Check database connection
2. Verify GitLab credentials are correct
3. Look at deployment error messages for specific issues
4. Try manual deployment:
   ```bash
   computor --profile config/profile.yaml deployment apply config/deployment.yaml
   ```

### Database Connection Issues

```
⚠ Cannot verify database connection
```

**Solution:**
1. Check database is running: `docker ps | grep postgres`
2. Verify database credentials in `.env`
3. Test connection: `psql -h localhost -U computor -d computor_test`

## Customizing Tests

### Adding New Test Cases

Edit the test scripts to add new test cases:

```python
# In test_student_permissions.py
test_cases = [
    # ... existing tests ...

    # Add your new test
    {
        "method": "GET",
        "endpoint": "/your-endpoint",
        "expected_status": 200,
        "description": "Your test description"
    },
]
```

### Creating New Users

Edit `config/deployment.yaml`:

```yaml
users:
  - username: newstudent
    email: newstudent@test.edu
    name: New Student
    password: ${STUDENT_PASSWORD:-student123}
    is_admin: false
```

Then re-run the setup script.

### Modifying Course Structure

Edit the `organizations` section in `config/deployment.yaml` to add:
- New courses
- Different content types
- Additional course families

## CI/CD Integration

These tests can be integrated into your CI/CD pipeline:

```bash
#!/bin/bash
# In your CI script

# Start services
docker-compose up -d

# Setup environment
cd tests/integration/scripts
./setup_test_environment.sh

# Run tests
python3 run_all_tests.py

# Exit with test result code
exit $?
```

## Additional Resources

- [Architecture Overview](../../docs/architecture-overview.md)
- [Developer Guidelines](../../docs/guideline.md)
- [Permission System Guide](../../docs/developer-guide/06-permission-system.md)
- [API Documentation](http://localhost:8000/docs) (when server is running)

## Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review logs in `data/` directory
3. Verify all prerequisites are met
4. Check that services are running correctly

## License

Same as the Computor project.
