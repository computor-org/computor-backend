# Development-specific Docker Compose override
# Extends docker-compose.base.yaml with development services and configuration

version: '3.8'

services:
  # Development API configuration (no container, runs locally)
  # Add this service when running API in a container for development

  # Temporal UI (only in development)
  temporal-ui:
    image: temporalio/ui:latest
    networks:
      - computor-network
    container_name: temporal-ui
    restart: unless-stopped
    ports:
      - "${TEMPORAL_UI_PORT:-8088}:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    depends_on:
      - temporal
    labels:
      - "traefik.enable=false"

  # Temporal Worker (Development with Hot Reload)
  temporal-worker:
    build:
      context: ../../
      dockerfile: ./docker/temporal-worker-dev/Dockerfile
    networks:
      - computor-network
    restart: unless-stopped
    deploy:
      replicas: ${TEMPORAL_WORKER_REPLICAS:-1}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=UTC
      - RUNNING_IN_DOCKER=true
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5437
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DEBUG_MODE=${DEBUG_MODE}
      - TOKEN_SECRET=${TOKEN_SECRET}
      - SYSTEM_GIT_EMAIL=${SYSTEM_GIT_EMAIL:-worker@computor.local}
      - SYSTEM_GIT_NAME=${SYSTEM_GIT_NAME:-Computor Worker}
      - PYTHONPATH=/home/worker/computor-backend/src
      - API_URL=${API_URL}
      - API_ADMIN_USER=${API_ADMIN_USER}
      - API_ADMIN_PASSWORD=${API_ADMIN_PASSWORD}
      - API_LOCAL_STORAGE_DIR=${API_LOCAL_STORAGE_DIR}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=false
    volumes:
      - ${SYSTEM_DEPLOYMENT_PATH}/shared:${API_ROOT_PATH}/shared
    depends_on:
      - temporal
      - postgres
      - redis
      - minio
    labels:
      - "traefik.enable=false"

  # Unified Testing Worker - handles Python, Octave, R, Julia, C, Fortran, Document
  temporal-worker-testing:
    build:
      context: ../../
      dockerfile: ./docker/temporal-worker-testing/Dockerfile
    networks:
      - computor-network
    restart: unless-stopped
    command: ["--queues=testing"]
    deploy:
      replicas: ${TESTING_WORKER_REPLICAS:-1}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=UTC
      - RUNNING_IN_DOCKER=true
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - API_URL=${API_URL}
      - API_TOKEN=${TESTING_WORKER_TOKEN}
      # Computor-testing framework configuration
      - TESTING_FRAMEWORK_URL=${TESTING_FRAMEWORK_URL}
      - TESTING_FRAMEWORK_TOKEN=${TESTING_FRAMEWORK_TOKEN}
      - TESTING_FRAMEWORK_VERSION=${TESTING_FRAMEWORK_VERSION}
      # Default testing configuration (can be overridden by service.config)
      - TESTING_EXECUTABLE=computor-test
      # Python test execution environment
      - PYTHON_TEST_VERSION=${PYTHON_TEST_VERSION:-3.13}
      - PYTHON_TEST_REQUIREMENTS=${PYTHON_TEST_REQUIREMENTS:-}
      # R configuration
      - R_LIBS_USER=/home/worker/.local/lib/R/library
    depends_on:
      - temporal
      - postgres
      - redis
    labels:
      - "traefik.enable=false"

  # MATLAB Testing Worker (for testing-matlab queue)
  temporal-worker-matlab:
    build:
      context: ../../
      dockerfile: ./docker/temporal-worker-matlab/Dockerfile
      args:
        MATLAB_BASE_IMAGE: ${MATLAB_BASE_IMAGE:-matlab-base:latest}
    networks:
      - computor-network
    restart: unless-stopped
    command: ["--queues=testing-matlab"]
    deploy:
      replicas: ${MATLAB_TESTING_WORKER_REPLICAS:-1}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=UTC
      - RUNNING_IN_DOCKER=true
      - TEMPORAL_HOST=temporal
      - TEMPORAL_PORT=7233
      - TEMPORAL_NAMESPACE=default
      - PYTHONPATH=/home/matlab/src
      - API_URL=${API_URL}
      - API_TOKEN=${MATLAB_WORKER_TOKEN}
      - MATLAB_TEST_ENGINE_URL=${MATLAB_TEST_ENGINE_URL}
      - MATLAB_TEST_ENGINE_TOKEN=${MATLAB_TEST_ENGINE_TOKEN}
      - MATLAB_TEST_ENGINE_VERSION=${MATLAB_TEST_ENGINE_VERSION}
      - MLM_LICENSE_FILE=${MATLAB_MLM_LICENSE_FILE}
    depends_on:
      - temporal
      - postgres
      - redis
    labels:
      - "traefik.enable=false"

  # Optional: Keycloak SSO (Development Only) - Uncomment to enable
  # keycloak-db:
  #   image: postgres:16
  #   networks:
  #     - computor-network
  #   container_name: computor-keycloak-db
  #   restart: unless-stopped
  #   volumes:
  #     - ${SYSTEM_DEPLOYMENT_PATH}/keycloak-db:/var/lib/postgresql/data
  #   ports:
  #     - "${KEYCLOAK_DB_PORT:-5434}:5438"
  #   environment:
  #     POSTGRES_USER: keycloak
  #     POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_secret}
  #     POSTGRES_DB: keycloak
  #     PGPORT: 5438
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U keycloak -p 5438"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5

  # keycloak:
  #   image: quay.io/keycloak/keycloak:25.0.6
  #   networks:
  #     - computor-network
  #   container_name: computor-keycloak
  #   restart: unless-stopped
  #   environment:
  #     KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
  #     KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
  #     KC_DB: postgres
  #     KC_DB_URL: jdbc:postgresql://keycloak-db:5438/keycloak
  #     KC_DB_USERNAME: keycloak
  #     KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak_secret}
  #     KC_HOSTNAME: localhost
  #     KC_HOSTNAME_PORT: ${KEYCLOAK_PORT:-8180}
  #     KC_HOSTNAME_STRICT: "false"
  #     KC_HOSTNAME_STRICT_HTTPS: "false"
  #     KC_HTTP_ENABLED: "true"
  #     KC_HTTP_PORT: 8080
  #     KC_HEALTH_ENABLED: "true"
  #   ports:
  #     - "${KEYCLOAK_PORT:-8180}:8080"
  #   command:
  #     - start-dev
  #     - --import-realm
  #   volumes:
  #     - ${SYSTEM_DEPLOYMENT_PATH}/keycloak/themes:/opt/keycloak/themes
  #     - ${SYSTEM_DEPLOYMENT_PATH}/keycloak/imports:/opt/keycloak/data/import
  #   depends_on:
  #     - keycloak-db
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   labels:
  #     - "traefik.enable=false"