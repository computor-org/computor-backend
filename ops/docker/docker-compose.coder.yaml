# Coder addon Docker Compose configuration
# Optional services for Coder workspace management
# Use together with base + dev/prod configuration
#
# Code-server access is via Traefik at /coder/{username}/{workspace}/
# (configured in workspace Terraform template via Docker labels)

services:
  # Dedicated PostgreSQL database for Coder (separate from main DB)
  coder-postgres:
    image: postgres:16
    networks:
      - computor-network
    container_name: computor-coder-postgres
    restart: unless-stopped
    ports:
      - "5439:5439"  # Different port from main postgres
    volumes:
      - ${SYSTEM_DEPLOYMENT_PATH}/coder-postgres:/var/lib/postgresql/data
    environment:
      TZ: UTC
      POSTGRES_USER: ${CODER_POSTGRES_USER:-coder}
      POSTGRES_PASSWORD: ${CODER_POSTGRES_PASSWORD:-coder_password}
      POSTGRES_DB: coder
      PGPORT: 5439
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CODER_POSTGRES_USER:-coder} -p 5439"]
      interval: 5s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  # Coder server (internal only - not exposed via Traefik)
  coder:
    image: ghcr.io/coder/coder:latest
    networks:
      - computor-network
    container_name: computor-coder
    restart: unless-stopped
    ports:
      - "7080:7080"  # Expose for local API access
    environment:
      CODER_PG_CONNECTION_URL: "postgresql://${CODER_POSTGRES_USER:-coder}:${CODER_POSTGRES_PASSWORD:-coder_password}@coder-postgres:5439/coder?sslmode=disable"
      CODER_HTTP_ADDRESS: "0.0.0.0:7080"
      # Internal URL - used by Coder for agent binary downloads (must be reachable from workspace containers)
      CODER_ACCESS_URL: "http://coder:7080"
      # Note: Password auth must stay enabled for admin API operations (CoderClient._get_session_token).
      # This is safe because Coder's port 7080 is not exposed through Traefik - users can't reach it.
      CODER_DISABLE_PASSWORD_AUTH: ${CODER_DISABLE_PASSWORD_AUTH:-false}
      CODER_DISABLE_SESSION_EXPIRY_REFRESH: ${CODER_DISABLE_SESSION_EXPIRY_REFRESH:-false}
      CODER_TELEMETRY_ENABLE: ${CODER_TELEMETRY_ENABLE:-false}
    group_add:
      - "${DOCKER_GID}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - coder_home:/home/coder
      - ${SYSTEM_DEPLOYMENT_PATH}/coder/templates:/templates
    depends_on:
      coder-postgres:
        condition: service_healthy
      coder-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7080/api/v2/buildinfo"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    labels:
      - "traefik.enable=false"

  # Local Docker registry for workspace images
  coder-registry:
    image: registry:2
    networks:
      - computor-network
    container_name: computor-coder-registry
    restart: unless-stopped
    ports:
      - "127.0.0.1:${CODER_REGISTRY_PORT:-5000}:5000"
    volumes:
      - coder_registry_data:/var/lib/registry
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/v2/"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Temporal worker for Coder tasks (image building, template pushing)
  # Triggered via API endpoints: POST /coder/admin/images/build, POST /coder/admin/templates/push
  temporal-worker-coder:
    build:
      context: ../../
      dockerfile: ./docker/temporal-worker-coder/Dockerfile
    networks:
      - computor-network
    restart: unless-stopped
    volumes:
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock
      - ${SYSTEM_DEPLOYMENT_PATH}/coder/templates:/templates:ro
    group_add:
      - "${DOCKER_GID}"
    environment:
      TEMPORAL_HOST: temporal
      TEMPORAL_PORT: 7233
      CODER_URL: http://coder:7080
      CODER_ENABLED: "true"
      CODER_ADMIN_EMAIL: ${CODER_ADMIN_EMAIL}
      CODER_ADMIN_PASSWORD: ${CODER_ADMIN_PASSWORD}
      CODER_TEMPLATES_DIR: /templates
      CODER_REGISTRY_HOST: coder-registry:5000
      DEBUG_MODE: ${DEBUG_MODE:-development}
      BACKEND_EXTERNAL_URL_DEV: ${BACKEND_EXTERNAL_URL_DEV:-http://host.docker.internal:8000}
      BACKEND_EXTERNAL_URL_PROD: ${BACKEND_EXTERNAL_URL_PROD:-}
      DEV_FORWARD_PORTS: ${DEV_FORWARD_PORTS:-}
      MATLAB_BASE_IMAGE: ${MATLAB_BASE_IMAGE:-matlab-base:latest}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      coder:
        condition: service_healthy

# Coder-specific volumes (isolated from main infrastructure)
volumes:
  coder_home:
    name: computor-coder-home
  coder_registry_data:
    name: computor-coder-registry
