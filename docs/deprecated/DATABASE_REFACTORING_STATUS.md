# Database Refactoring Status

## Completed Tasks

### 1. Model Analysis and Comparison
- Analyzed existing SQLAlchemy models in `models.py`
- Compared with PostgreSQL migrations (V1.000-V1.018)
- Identified missing tables and fields

### 2. Model Reorganization
- Created new organized model structure in `src/ctutor_backend/model/sqlalchemy_models/`
- Separated models into logical files:
  - `auth.py`: User, Account, Profile, StudentProfile, Session
  - `organization.py`: Organization with ltree support
  - `role.py`: Role, RoleClaim, UserRole
  - `group.py`: Group, GroupClaim, UserGroup
  - `execution.py`: ExecutionBackend
  - `course.py`: All course-related models
  - `result.py`: Result model
  - `message.py`: Message and MessageRead (previously missing)

### 3. Added Missing Elements
- Added `auth_token` field to User model
- Added `parent_path` computed column to Organization
- Created Message and MessageRead models (previously missing)
- Fixed all model relationships and back-references

### 4. Alembic Configuration
- Updated `alembic/env.py` to use the new models' metadata
- Created initial migration for PostgreSQL extensions (`000_postgresql_extensions_and_functions.py`)
- Added migration helper script (`migration_helper.py`)

## Next Steps

### 1. Generate Initial Schema Migration
```bash
cd src/ctutor_backend
# Set environment variables
export POSTGRES_URL=localhost
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=postgres
export POSTGRES_DB=ctutor_test

# Generate the migration
alembic revision --autogenerate -m "initial_sqlalchemy_schema"
```

### 2. Review and Edit Generated Migration
The autogenerated migration will need manual review for:
- Trigger implementations
- Complex constraints
- Custom indexes
- Any PostgreSQL-specific features

### 3. Test Migration Process
1. Create a test database
2. Run the extensions migration first
3. Run the schema migration
4. Verify all tables, constraints, and relationships

### 4. Update Application Code
- Update imports to use new model structure
- Replace references to `models.py` with `sqlalchemy_models`
- Test all database operations

## Benefits Achieved

1. **Better Organization**: Models are now logically separated
2. **Complete Schema**: Added missing tables (Message, MessageRead)
3. **Proper Relationships**: All foreign keys and back-references configured
4. **Alembic Integration**: Ready for autogenerate migrations
5. **Single Source of Truth**: SQLAlchemy models will be the definitive schema

## Risks to Monitor

1. **Data Migration**: Existing data needs careful migration
2. **Trigger Functions**: Some PostgreSQL triggers need manual implementation
3. **Performance**: Verify indexes are properly created
4. **Compatibility**: Ensure all existing code works with new models