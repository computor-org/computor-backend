# Nginx configuration for Coder with workspace creation protection
#
# This config blocks workspace and user creation API calls unless
# the request includes a valid X-Admin-Secret header.
#
# SETUP:
# 1. Replace YOUR_SECRET_HERE with a secure random string
# 2. Replace YOUR_DOMAIN and PORT with your values
# 3. Copy to /etc/nginx/sites-available/coder
# 4. ln -s /etc/nginx/sites-available/coder /etc/nginx/sites-enabled/
# 5. nginx -t && systemctl reload nginx
#
# USAGE FROM FASTAPI:
#   headers = {"X-Admin-Secret": "YOUR_SECRET_HERE"}
#   requests.post(f"{CODER_URL}/api/v2/users", headers=headers, json=data)

# Map to check if request has valid admin secret
map $http_x_admin_secret $has_admin_secret {
    default 0;
    "YOUR_SECRET_HERE" 1;  # <-- CHANGE THIS
}

server {
    listen 443 ssl http2;
    server_name YOUR_DOMAIN;  # <-- CHANGE THIS (e.g., coder.example.com)

    # SSL configuration (adjust paths as needed)
    ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # Coder backend (adjust port if needed)
    set $coder_backend http://127.0.0.1:7080;  # <-- CHANGE PORT IF NEEDED

    # Increase buffer sizes for WebSocket and large responses
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # WebSocket support (required for Coder)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeout settings for long-running connections (workspace builds, WebSockets)
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 86400s;  # 24h for WebSocket connections

    # =========================================================
    # PROTECTED ENDPOINTS - Require X-Admin-Secret header
    # =========================================================

    # Block workspace creation without admin secret
    # POST /api/v2/organizations/{org}/members/{user}/workspaces
    location ~ ^/api/v2/organizations/[^/]+/members/[^/]+/workspaces$ {
        # Only block POST requests (creating workspaces)
        if ($request_method = POST) {
            set $check_secret "POST";
        }
        if ($has_admin_secret = 0) {
            set $check_secret "${check_secret}_BLOCKED";
        }
        if ($check_secret = "POST_BLOCKED") {
            add_header Content-Type application/json always;
            return 403 '{"message": "Workspace creation requires admin authorization", "detail": "Missing or invalid X-Admin-Secret header"}';
        }

        proxy_pass $coder_backend;
    }

    # Block user creation without admin secret
    # POST /api/v2/users
    location = /api/v2/users {
        if ($request_method = POST) {
            set $check_user "POST";
        }
        if ($has_admin_secret = 0) {
            set $check_user "${check_user}_BLOCKED";
        }
        if ($check_user = "POST_BLOCKED") {
            add_header Content-Type application/json always;
            return 403 '{"message": "User creation requires admin authorization", "detail": "Missing or invalid X-Admin-Secret header"}';
        }

        proxy_pass $coder_backend;
    }

    # =========================================================
    # ALL OTHER REQUESTS - Pass through normally
    # =========================================================

    location / {
        proxy_pass $coder_backend;
    }
}

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name YOUR_DOMAIN;  # <-- CHANGE THIS
    return 301 https://$server_name$request_uri;
}
