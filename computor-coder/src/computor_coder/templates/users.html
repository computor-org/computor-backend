{% extends "base.html" %}

{% block title %}User Management - Coder Workspaces{% endblock %}

{% block content %}
<div class="users-page">
    <div class="page-header">
        <h1>Workspace Role Management</h1>
    </div>
    <p class="page-description">Assign or remove <strong>Workspace User</strong> and <strong>Workspace Maintainer</strong> roles.</p>

    <!-- Toolbar: assign form + search -->
    <div class="users-toolbar">
        <div class="assign-role-form card">
            <h4>Assign Role by Email</h4>
            <form id="assign-form" onsubmit="assignRoleByEmail(event)">
                <div class="form-row">
                    <div class="form-group-inline">
                        <label for="email">User Email</label>
                        <input type="email" id="email" name="email" placeholder="user@example.com" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="role_id">Role</label>
                        <select id="role_id" name="role_id" required>
                            <option value="_workspace_user">Workspace User</option>
                            <option value="_workspace_maintainer">Workspace Maintainer</option>
                        </select>
                    </div>
                    <div class="form-group-inline form-group-action">
                        <button type="submit" class="btn btn-primary" id="assign-btn">Assign</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="search-box card">
            <h4>Filter</h4>
            <input type="text" id="search-input" placeholder="Search by name, email..." oninput="filterUsers()">
        </div>
    </div>

    <!-- Users table -->
    <div id="users-table-container">
        <p class="loading">Loading users...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ROLES_BASE = '/workspaces/roles';
let allUsers = [];

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

function loadUsers() {
    const container = document.getElementById('users-table-container');

    fetch(ROLES_BASE + '/users', { credentials: 'include' })
        .then(r => {
            if (!r.ok) throw new Error('Failed to fetch users');
            return r.json();
        })
        .then(users => {
            allUsers = users;
            renderUsers(users);
        })
        .catch(err => {
            container.innerHTML = `
                <div class="error-state">
                    <p class="status-error">Failed to load users: ${err.message}</p>
                </div>
            `;
        });
}

function renderUsers(users) {
    const container = document.getElementById('users-table-container');

    if (users.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <h3>No Users Found</h3>
                <p>Use the form above to assign workspace roles by email.</p>
            </div>
        `;
        return;
    }

    let rows = users.map(u => {
        const name = [u.given_name, u.family_name].filter(Boolean).join(' ') || '-';

        const hasUser = u.roles.includes('_workspace_user');
        const hasMaintainer = u.roles.includes('_workspace_maintainer');

        const roleBadges = u.roles.length > 0
            ? u.roles.map(r =>
                `<span class="role-badge role-${r.replace('_workspace_', '')}">
                    ${formatRoleName(r)}
                    <button class="role-remove" onclick="removeRole('${u.user_id}', '${r}')" title="Remove">&times;</button>
                </span>`
            ).join('')
            : '<span class="no-roles">&mdash;</span>';

        // Build add-role options: only show roles the user doesn't have yet
        let addOptions = '';
        if (!hasUser) addOptions += `<option value="_workspace_user">+ User</option>`;
        if (!hasMaintainer) addOptions += `<option value="_workspace_maintainer">+ Maintainer</option>`;

        const addControl = addOptions
            ? `<select class="role-add-select" onchange="addRoleInline('${u.user_id}', '${u.email || ''}', this)">
                   <option value="">Add...</option>
                   ${addOptions}
               </select>`
            : '';

        return `
            <tr>
                <td class="user-name">${name}</td>
                <td class="user-email">${u.email || '-'}</td>
                <td class="user-username">${u.username || '-'}</td>
                <td><div class="roles-cell">${roleBadges} ${addControl}</div></td>
            </tr>
        `;
    }).join('');

    container.innerHTML = `
        <div class="users-table-wrapper">
            <div class="users-table-header">
                <h3>All Users</h3>
                <span class="users-count">${users.length} user${users.length !== 1 ? 's' : ''}</span>
            </div>
            <table class="users-table">
                <colgroup>
                    <col class="col-name">
                    <col class="col-email">
                    <col class="col-username">
                    <col class="col-roles">
                </colgroup>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Roles</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}

function filterUsers() {
    const query = document.getElementById('search-input').value.toLowerCase().trim();
    if (!query) {
        renderUsers(allUsers);
        return;
    }
    const filtered = allUsers.filter(u => {
        const name = [u.given_name, u.family_name].filter(Boolean).join(' ').toLowerCase();
        const email = (u.email || '').toLowerCase();
        const username = (u.username || '').toLowerCase();
        return name.includes(query) || email.includes(query) || username.includes(query);
    });
    renderUsers(filtered);
}

function formatRoleName(roleId) {
    switch (roleId) {
        case '_workspace_user': return 'User';
        case '_workspace_maintainer': return 'Maintainer';
        default: return roleId;
    }
}

function doAssign(email, roleId) {
    return fetch(ROLES_BASE + '/assign', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, role_id: roleId }),
    }).then(r => {
        if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
        return r.json();
    });
}

function assignRoleByEmail(event) {
    event.preventDefault();
    const btn = document.getElementById('assign-btn');
    const email = document.getElementById('email').value;
    const roleId = document.getElementById('role_id').value;

    btn.disabled = true;
    btn.textContent = 'Assigning...';

    doAssign(email, roleId)
        .then(() => {
            showNotification(`Assigned ${formatRoleName(roleId)} to ${email}`, 'success');
            document.getElementById('email').value = '';
            loadUsers();
        })
        .catch(err => {
            showNotification(err.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Assign';
        });
}

function addRoleInline(userId, email, selectEl) {
    const roleId = selectEl.value;
    if (!roleId) return;
    selectEl.disabled = true;

    doAssign(email, roleId)
        .then(() => {
            showNotification(`Assigned ${formatRoleName(roleId)}`, 'success');
            loadUsers();
        })
        .catch(err => {
            showNotification(err.message, 'error');
            selectEl.disabled = false;
            selectEl.value = '';
        });
}

function removeRole(userId, roleId) {
    if (!confirm(`Remove ${formatRoleName(roleId)} role from this user?`)) return;

    fetch(`${ROLES_BASE}/users/${userId}/${roleId}`, {
        method: 'DELETE',
        credentials: 'include',
    })
        .then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
            return r.json();
        })
        .then(() => {
            showNotification('Role removed', 'success');
            loadUsers();
        })
        .catch(err => {
            showNotification('Failed to remove role: ' + err.message, 'error');
        });
}
</script>
{% endblock %}
