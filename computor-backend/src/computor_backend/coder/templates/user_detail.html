{% extends "base.html" %}

{% block title %}User Details{% endblock %}

{% block content %}
<div class="user-detail-page">
    <div class="page-header">
        <a href="{{ url_for('coder_users_page') }}" class="back-link">&larr; Back to Users</a>
        <h1>User Details</h1>
    </div>

    <!-- User Info Card -->
    <div class="user-info-card card">
        <div class="user-info-grid">
            <div class="info-item">
                <label>Name</label>
                <span id="user-name">Loading...</span>
            </div>
            <div class="info-item">
                <label>Email</label>
                <span id="user-email">Loading...</span>
            </div>
            <div class="info-item">
                <label>Username</label>
                <span id="user-username">Loading...</span>
            </div>
            <div class="info-item">
                <label>User ID</label>
                <span id="user-id">{{ user_id }}</span>
            </div>
            <div class="info-item">
                <label>Roles</label>
                <span id="user-roles">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Workspace Actions -->
    <div class="workspace-actions card">
        <h3>Workspace Management</h3>
        <div class="actions-row">
            <button class="btn btn-primary" id="provision-btn" onclick="provisionWorkspace()" disabled>
                Provision New Workspace
            </button>
            <button class="btn btn-secondary" onclick="loadWorkspaces()">
                Refresh
            </button>
        </div>
    </div>

    <!-- Workspaces Table -->
    <div class="workspaces-section">
        <h3>Workspaces</h3>
        <div id="workspaces-container">
            <p class="loading">Loading workspaces...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const USER_ID = '{{ user_id }}';
const ROLES_BASE = '/workspaces/roles';
let currentUser = null;

document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
});

function loadUserInfo() {
    // Fetch user info from the roles API
    fetch(ROLES_BASE + '/users', { credentials: 'include' })
        .then(r => {
            if (!r.ok) throw new Error('Failed to fetch users');
            return r.json();
        })
        .then(users => {
            currentUser = users.find(u => u.user_id === USER_ID);
            if (!currentUser) {
                throw new Error('User not found');
            }
            renderUserInfo(currentUser);
            loadWorkspaces();
        })
        .catch(err => {
            document.getElementById('user-name').textContent = 'Error';
            document.getElementById('user-email').textContent = err.message;
            document.getElementById('user-username').textContent = '-';
            document.getElementById('user-roles').textContent = '-';
        });
}

function renderUserInfo(user) {
    const name = [user.given_name, user.family_name].filter(Boolean).join(' ') || '-';
    document.getElementById('user-name').textContent = name;
    document.getElementById('user-email').textContent = user.email || '-';
    document.getElementById('user-username').textContent = user.username || '-';

    // Render roles
    const rolesEl = document.getElementById('user-roles');
    if (user.roles && user.roles.length > 0) {
        rolesEl.innerHTML = user.roles.map(r =>
            `<span class="role-badge role-${r.replace('_workspace_', '')}">${formatRoleName(r)}</span>`
        ).join(' ');
    } else {
        rolesEl.textContent = 'No workspace roles';
    }

    // Enable provision button if user has email
    if (user.email) {
        document.getElementById('provision-btn').disabled = false;
    }
}

function formatRoleName(roleId) {
    switch (roleId) {
        case '_workspace_user': return 'User';
        case '_workspace_maintainer': return 'Maintainer';
        default: return roleId;
    }
}

function loadWorkspaces() {
    const container = document.getElementById('workspaces-container');

    if (!currentUser || !currentUser.email) {
        container.innerHTML = '<p class="status-error">Cannot load workspaces: user has no email</p>';
        return;
    }

    container.innerHTML = '<p class="loading">Loading workspaces...</p>';

    fetch(`${API_BASE}/workspaces?email=${encodeURIComponent(currentUser.email)}`, { credentials: 'include' })
        .then(r => {
            if (!r.ok) throw new Error('Failed to fetch workspaces');
            return r.json();
        })
        .then(data => {
            renderWorkspaces(data.workspaces || []);
        })
        .catch(err => {
            container.innerHTML = `
                <div class="error-state">
                    <p class="status-error">Failed to load workspaces: ${err.message}</p>
                </div>
            `;
        });
}

function renderWorkspaces(workspaces) {
    const container = document.getElementById('workspaces-container');

    if (workspaces.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>No workspaces found for this user.</p>
                <p>Click "Provision New Workspace" to create one.</p>
            </div>
        `;
        return;
    }

    const rows = workspaces.map(ws => {
        const statusClass = getStatusClass(ws.status);
        const isRunning = ws.status?.toLowerCase() === 'running';
        const isStopped = ws.status?.toLowerCase() === 'stopped';

        return `
            <tr>
                <td class="ws-name">${ws.name}</td>
                <td class="ws-template">${ws.template_name || '-'}</td>
                <td class="ws-status">
                    <span class="status-badge status-${statusClass}">${ws.status || 'unknown'}</span>
                </td>
                <td class="ws-created">${formatDate(ws.created_at)}</td>
                <td class="ws-actions">
                    ${isRunning ? `
                        <button class="btn btn-sm btn-secondary" onclick="stopWorkspace('${ws.owner_name}', '${ws.name}')">Stop</button>
                        <a href="${ws.url || '#'}" target="_blank" class="btn btn-sm btn-primary">Open</a>
                    ` : ''}
                    ${isStopped ? `
                        <button class="btn btn-sm btn-primary" onclick="startWorkspace('${ws.owner_name}', '${ws.name}')">Start</button>
                    ` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteWorkspace('${ws.owner_name}', '${ws.name}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');

    container.innerHTML = `
        <table class="workspaces-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Template</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
}

function provisionWorkspace() {
    if (!currentUser || !currentUser.email) {
        showNotification('Cannot provision: user has no email', 'error');
        return;
    }

    const btn = document.getElementById('provision-btn');
    btn.disabled = true;
    btn.textContent = 'Provisioning...';

    fetch(`${API_BASE}/workspaces/provision`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentUser.email, template: 'python-workspace', workspace_name: 'workspace' }),
    })
        .then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.message || e.detail || 'Provisioning failed'); });
            return r.json();
        })
        .then(result => {
            if (result.created_workspace) {
                showNotification('Workspace provisioned successfully', 'success');
            } else {
                showNotification('User already has a workspace', 'info');
            }
            loadWorkspaces();
        })
        .catch(err => {
            showNotification('Provisioning failed: ' + err.message, 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Provision New Workspace';
        });
}

function startWorkspace(username, workspaceName) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Starting...';

    fetch(`${API_BASE}/workspaces/${username}/${workspaceName}/start`, {
        method: 'POST',
        credentials: 'include',
    })
        .then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
            return r.json();
        })
        .then(() => {
            showNotification('Workspace starting...', 'success');
            setTimeout(loadWorkspaces, 2000);
        })
        .catch(err => {
            showNotification('Failed to start: ' + err.message, 'error');
            btn.disabled = false;
            btn.textContent = 'Start';
        });
}

function stopWorkspace(username, workspaceName) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Stopping...';

    fetch(`${API_BASE}/workspaces/${username}/${workspaceName}/stop`, {
        method: 'POST',
        credentials: 'include',
    })
        .then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
            return r.json();
        })
        .then(() => {
            showNotification('Workspace stopping...', 'success');
            setTimeout(loadWorkspaces, 2000);
        })
        .catch(err => {
            showNotification('Failed to stop: ' + err.message, 'error');
            btn.disabled = false;
            btn.textContent = 'Stop';
        });
}

function deleteWorkspace(username, workspaceName) {
    if (!confirm(`Are you sure you want to delete workspace "${workspaceName}"? This cannot be undone.`)) {
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Deleting...';

    fetch(`${API_BASE}/workspaces/${username}/${workspaceName}`, {
        method: 'DELETE',
        credentials: 'include',
    })
        .then(r => {
            if (!r.ok) return r.json().then(e => { throw new Error(e.detail || 'Failed'); });
            return r.json();
        })
        .then(() => {
            showNotification('Workspace deleted', 'success');
            loadWorkspaces();
        })
        .catch(err => {
            showNotification('Failed to delete: ' + err.message, 'error');
            btn.disabled = false;
            btn.textContent = 'Delete';
        });
}
</script>
{% endblock %}
